# **SocioGraph Rebuild — Phase 9 Deep‑Dive Plan**

> **Objective:** Ship SocioGraph to the cloud with **repeatable IaC**, automated blue‑green deploys, and a **24 × 7 observability stack** (metrics, logs, traces, alerts, dashboards).

---

## 🎯 Outcomes

| ID | Outcome | Acceptance Criteria |
|----|---------|---------------------|
| O‑9.1 | A **Terraform** state brings up all core infra in one command with no manual tweaks. | `terraform apply -auto-approve` completes. |
| O‑9.2 | **Blue‑green** deployment pipeline (GitHub Actions) swaps traffic between two ECS services with zero downtime < 1 s. | `ab -n1000 -c50` shows 0 % failed during swap. |
| O‑9.3 | **ALB** public endpoint serves API at `/` and static UI under `/app`. HTTPS via ACM cert. | `curl -I https://api.sociograph.dev/health` returns 200. |
| O‑9.4 | **Prometheus + Grafana** dashboards show: RPS, p95 latency, vector‑DB query time, GPU utilisation. | Dashboard screenshot attached to PR. |
| O‑9.5 | **Alertmanager** sends Slack alert when p95 latency > 500 ms for 5 min. | Fire drill alert captured. |
| O‑9.6 | **OpenTelemetry** traces span FastAPI → retrieval → LLM call, viewable in **Tempo**. | Jaeger or Tempo UI shows trace graph. |
| O‑9.7 | S3 daily backup of `vector_store/` & `graph.db` with lifecycle policy 30 days. | Automated backup file timestamped. |
| O‑9.8 | **Cost report** generated by Infracost shows total monthly < 200 USD at 50 k requests/day. | Markdown summary committed. |

---

## 📋 Target Architecture fileciteturn0file8

```
            ┌────────┐
  users ───► │  ALB   │
            /┴────────┴        /────────┬────────  /api  /app   blue   green  (ECS Fargate)
               │      │
     ┌─────────┴┐   ┌─┴─────────┐
     │   API    │   │   API     │  (Docker images built Phase 8)
     │  (uvicorn)│   │ (uvicorn)│
     └────┬──────┘   └────┬─────┘
          │               │
   S3 <───┴─ vector_store │
          │               │
   RDS pg ─── graph.db replica
          │
      ┌───▼───┐
      │  Prom │───► Grafana     (metrics)
      └───┬───┘
          │
      OpenTelemetry ► Tempo + Loki + Alertmanager
```

---

## ⚙️ Prerequisites

* **Phase 8 image** `sociograph/backend:latest` pushed to Docker Hub.
* AWS account with IAM user allowing ECS, VPC, S3, ACM, CloudWatch, CloudFormation.
* Terraform ≥ 1.8, Infracost CLI, AWS CLI configured (`aws configure`).

Install tools:

```bash
brew install terraform infracost
pip install opentelemetry-sdk opentelemetry-exporter-otlp
```

---

## 🛠️ Step‑by‑Step Implementation

### 1  Repository Structure

```
infra/
  main.tf
  variables.tf
  outputs.tf
  ecs.tf
  alb.tf
  rds.tf
  s3.tf
  observability.tf
.github/workflows/deploy.yml
ops/
  dashboards/
  alerts/
```

### 2  Terraform Modules

* **VPC + Subnets**: Use `terraform-aws-modules/vpc/aws`.
* **ECS Cluster**: `terraform-aws-modules/ecs/aws` with two services `sg-blue`, `sg-green`.
* **ALB**: Listener rules route 100 % traffic to active target group tag `color=blue|green`.
* **RDS PostgreSQL** as replacement for SQLite when scale demands (optional, keep EBS volume for now).
* **S3 bucket** `sociograph-backup` + lifecycle rule.

`variables.tf` exposes:

```hcl
variable "color_active" { description = "Live service color" type = string default = "blue" }
variable "image_tag"     { description = "Docker image tag"  type = string default = "latest" }
```

### 3  Observability Stack

* Deploy **Grafana Cloud** Free tier or self‑hosted Grafana Loki + Tempo via **Prometheus community Helm charts** (`helmfile.yaml`).
* FastAPI integrated with:

```python
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
FastAPIInstrumentor.instrument_app(app, excluded_urls="/docs,/static")
```

* Use **prometheus‑fastapi‑instrumentator** for metrics:

```python
from prometheus_fastapi_instrumentator import Instrumentator
Instrumentator().instrument(app).expose(app)
```

* Alerts: `alerts.yaml`:

```yaml
groups:
- name: latency
  rules:
  - alert: P95High
    expr: histogram_quantile(0.95, sum(rate(request_duration_seconds_bucket[5m])) by (le)) > 0.5
    for: 5m
    labels: {severity: warning}
    annotations:
      summary: "High latency p95 > 500 ms"
```

### 4  GitHub Actions Deploy Workflow

**`.github/workflows/deploy.yml`**

```yaml
name: Deploy
on:
  push:
    branches: [main]
    paths: ["backend/**", "infra/**"]
jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform -chdir=infra init
      - run: terraform -chdir=infra plan -out=tfplan
      - name: infracost
        uses: infracost/actions@v2
        with:
          path: infra
  apply:
    needs: plan
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform -chdir=infra apply -auto-approve
```

Blue‑green switch: on success, workflow sets `color_active` variable via `terraform apply -var="color_active=green"` and then `blue` next deploy.

### 5  Backup Cron

Add **EventBridge Rule** triggering `aws s3 sync` Lambda or `aws backup start-backup-job` every 24 h.

### 6  Cost Estimation

Run:

```bash
infracost breakdown --path infra --format markdown   --usage-file infracost-usage.yml -o infracost.md
```

Commit report.

---

## 📝 Validation Script

1. `terraform apply` in sandbox AWS account.  
2. `ab -n200 -c20 https://alb-dns/search` with dummy query; ensure p95 < 500 ms.  
3. Kill blue service task; ALB health check shifts to green, zero 5xx.  
4. Grafana board shows traffic.  
5. `aws s3 ls s3://sociograph-backup/$(date +%F)` contains objects.

---

## 🕑 Estimated Effort

| Task | Time (hrs) |
|------|------------|
| Terraform modules & VPC | 4 |
| ECS blue‑green & ALB | 3 |
| Observability stack (Helm) | 2 |
| GitHub Actions deploy | 1 |
| OpenTelemetry integration | 1 |
| Backup + cost reporting | 1 |
| **Total** | **~12 hrs** |

---

## 🚑 Troubleshooting & Tips

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| **503 on deploy** | Health check grace too short | Set `healthcheck_grace_period = 60` in ECS service. |
| **Prometheus scrape failed** | Targets in private subnet | Add NAT Gateway or scrape via ServiceMonitor in EKS. |
| **Terraform state locking** | Concurrent applies | Enable DynamoDB lock table. |
| High AWS bill alerts | Forgotten GPU spot in dev | Add `deletion_protection=false` and Auto Stop dev services. |

---

## 📝 Deliverables

1. **`infra/`** Terraform config & README.  
2. **CI/CD deploy workflow** in `.github/workflows/deploy.yml`.  
3. **Observability** Helm charts & dashboards JSON.  
4. **Cost report** `infracost.md`.  
5. Docs for rollback procedure.  
6. Git tag **`phase‑9`**.

---

_When Terraform spins resources, ALB answers HTTPS, Grafana & Tempo show live data, and GitHub Actions swaps blue‑green safely, **Phase 9 is complete** — SocioGraph production‑ready!_
